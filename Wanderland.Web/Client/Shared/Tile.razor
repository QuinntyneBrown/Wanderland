@inject Wanderland.Web.Shared.IWanderlandHttpApiClient _apiClient
@inject Wanderland.Web.Client.Services.WanderlandHubClient _hubClient

<MudPaper Height="80px"
          Width="80px"
          Class="mx-auto"
          Style='@($"background:{GetColorForTile()}")'>
    <MudAvatarGroup Max="5" Spacing="2" MaxColor="Color.Primary">
        @if (Model != null)
        {
            @foreach (var wanderer in Model.WanderersHere)
            {
                if (string.IsNullOrEmpty(wanderer.AvatarImageUrl))
                {
                    <MudAvatar Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">
                        <MudIcon Color="Color.Dark" Icon="@Icons.Material.Filled.DirectionsWalk" Size="Size.Small" />
                    </MudAvatar>
                }
                else
                {
                    <MudAvatar Image="@wanderer.AvatarImageUrl" Variant="Variant.Filled" />
                }
            }
        }
    </MudAvatarGroup>
</MudPaper>

@code {
    [Parameter]
    public int Row { get; set; }

    [Parameter]
    public int Column { get; set; }

    [Parameter]
    public string? WorldName { get; set; }

    private Wanderland.Web.Shared.Tile Model { get; set; }
    private TileType TileType;
    private bool shouldRender = false;

    protected override bool ShouldRender() => shouldRender;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(WorldName))
        {
            Model = await _apiClient.GetTileCurrentState(WorldName, Row, Column);
            _hubClient.TileUpdate += (s, args) =>
            {
                if (args.Tile.World == this.WorldName && args.Tile.Row == this.Row && args.Tile.Column == this.Column)
                {
                    Model = args.Tile;
                    base.StateHasChanged();
                }

            };
            TileType = Model.Type;
            shouldRender = true;
        }
    }

    protected string GetColorForTile()
    {
        if (Model?.Type == TileType.Barrier)
            return Colors.Shades.Black;

        if (Model?.Column == 0) return Colors.BlueGrey.Lighten5;
        if (Model?.Column == 1) return Colors.BlueGrey.Lighten4;
        if (Model?.Column == 2) return Colors.BlueGrey.Lighten3;
        if (Model?.Column == 3) return Colors.BlueGrey.Lighten2;
        if (Model?.Column == 4) return Colors.BlueGrey.Lighten1;
        if (Model?.Column == 5) return Colors.BlueGrey.Default;
        if (Model?.Column == 6) return Colors.BlueGrey.Darken1;
        if (Model?.Column == 7) return Colors.BlueGrey.Darken2;
        if (Model?.Column == 8) return Colors.BlueGrey.Darken3;
        
        return Colors.BlueGrey.Darken4;
    }
}
